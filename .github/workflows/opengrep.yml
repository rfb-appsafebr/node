name: ðŸ”Ž SAST - Opengrep (JSON/SARIF â†’ HTML)

on:
  pull_request:
  push:
    branches: ["main", "master"]
  workflow_dispatch:

jobs:
  opengrep:
    runs-on: ubuntu-latest
    permissions:
      contents: read

    steps:
      - name: ðŸ› ï¸ Checkout
        uses: actions/checkout@v4

      - name: âš™ï¸ Install Opengrep (fix PATH)
        shell: bash
        run: |
          set -euo pipefail

          curl -fsSL https://raw.githubusercontent.com/opengrep/opengrep/main/install.sh | bash

          # DisponÃ­vel no step atual
          export PATH="$HOME/.opengrep/cli/latest:$PATH"

          # DisponÃ­vel nos prÃ³ximos steps
          echo "$HOME/.opengrep/cli/latest" >> "$GITHUB_PATH"

          opengrep --version

      - name: ðŸ§© Install prospector2html
        shell: bash
        run: |
          set -euo pipefail
          python3 -m pip install --upgrade pip
          python3 -m pip install prospector2html

      - name: ðŸ”Ž Run Opengrep (no-fail)
        shell: bash
        run: |
          set -euo pipefail

          # Alguns builds usam "opengrep scan", outros aceitam "opengrep" estilo semgrep.
          # Tenta "scan" primeiro, e se nÃ£o existir, cai pro modo direto.
          if opengrep --help | grep -qE '^\s*scan\b'; then
            opengrep scan --config auto \
              --json-output=opengrep.json \
              --sarif-output=opengrep.sarif \
              . || true
          else
            opengrep --config auto \
              --json --output opengrep.json \
              . || true
          fi

          test -f opengrep.json || echo '{}' > opengrep.json
          test -f opengrep.sarif || echo '{}' > opengrep.sarif

      - name: ðŸ§¾ Convert JSON â†’ HTML (prospector2html)
        shell: bash
        run: |
          set -euo pipefail
          prospector-html -i opengrep.json -o opengrep_report.html --filter semgrep || true
          test -f opengrep_report.html || echo "<html><body><p>NÃ£o foi possÃ­vel gerar o HTML.</p></body></html>" > opengrep_report.html

      - name: ðŸ“¤ Upload artifacts
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: opengrep-report
          path: |
            opengrep.json
            opengrep.sarif
            opengrep_report.html
