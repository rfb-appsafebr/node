name: ðŸ§¨ DAST - Nuclei (JSONL â†’ HTML)

on:
  workflow_dispatch:
  pull_request:
  push:
    branches: ["main", "master"]

jobs:
  nuclei:
    runs-on: ubuntu-latest
    permissions:
      contents: read

    env:
      NUCLEI_TARGET: ${{ secrets.NUCLEI_TARGET }}

    steps:
      - name: ðŸ› ï¸ Checkout
        uses: actions/checkout@v4

      - name: âš™ï¸ Install jq
        shell: bash
        run: |
          sudo apt-get update
          sudo apt-get install -y --no-install-recommends jq

      - name: ðŸ§ª Guard (skip if no target)
        shell: bash
        run: |
          if [ -z "${NUCLEI_TARGET}" ]; then
            echo "NUCLEI_TARGET nÃ£o configurado em secrets. Pulando scan."
            exit 0
          fi

      - name: ðŸš€ Run Nuclei (no fail, JSONL)
        uses: projectdiscovery/nuclei-action@v1.0.3
        with:
          target: ${{ env.NUCLEI_TARGET }}
          args: >
            -jsonl
            -o nuclei.jsonl
            -severity critical,high,medium

      - name: ðŸ§¾ Convert nuclei.jsonl â†’ HTML
        shell: bash
        run: |
          set -euo pipefail
          touch nuclei.jsonl

          cat > nuclei_report.html <<'HTML'
          <!doctype html><html lang="pt-BR"><head>
          <meta charset="utf-8"/><meta name="viewport" content="width=device-width, initial-scale=1"/>
          <title>Nuclei Report</title>
          <style>
            body{font-family:system-ui,-apple-system,Segoe UI,Roboto,Arial;margin:24px;color:#111}
            .card{border:1px solid #e5e7eb;border-radius:12px;padding:16px;margin-bottom:16px}
            table{width:100%;border-collapse:collapse;margin-top:10px}
            th,td{border-bottom:1px solid #eee;padding:10px;font-size:13px;text-align:left;vertical-align:top}
            th{background:#fafafa}
            code{font-family:ui-monospace,Menlo,Consolas,monospace;font-size:12px}
          </style></head><body>
          <div class="card"><h2 style="margin:0">Nuclei Report</h2><div style="color:#555;font-size:13px">Fonte: <code>nuclei.jsonl</code></div></div>
          <div class="card"><div style="overflow:auto;max-height:70vh;border:1px solid #f3f4f6;border-radius:10px">
          <table><thead><tr>
            <th>Template</th><th>Severidade</th><th>Host</th><th>Matched</th><th>Info</th>
          </tr></thead><tbody>
          HTML

          jq -r '
            select(type=="object") |
            [
              (.templateID // ""),
              (.info.severity // ""),
              (.host // ""),
              (.matched // ""),
              (.info.name // "")
            ] |
            "<tr>"
            + "<td><code>" + (.[0]|tostring|gsub("&";"&amp;")|gsub("<";"&lt;")|gsub(">";"&gt;")) + "</code></td>"
            + "<td>" + (.[1]|tostring|gsub("&";"&amp;")|gsub("<";"&lt;")|gsub(">";"&gt;")) + "</td>"
            + "<td>" + (.[2]|tostring|gsub("&";"&amp;")|gsub("<";"&lt;")|gsub(">";"&gt;")) + "</td>"
            + "<td><code>" + (.[3]|tostring|gsub("&";"&amp;")|gsub("<";"&lt;")|gsub(">";"&gt;")) + "</code></td>"
            + "<td>" + (.[4]|tostring|gsub("&";"&amp;")|gsub("<";"&lt;")|gsub(">";"&gt;")) + "</td>"
            + "</tr>"
          ' nuclei.jsonl >> nuclei_report.html || true

          if ! grep -q "<tr>" nuclei_report.html; then
            echo "<tr><td colspan='5'>Nenhum finding encontrado.</td></tr>" >> nuclei_report.html
          fi

          cat >> nuclei_report.html <<'HTML'
          </tbody></table></div></div></body></html>
          HTML

      - name: ðŸ“¤ Upload artifacts
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: nuclei-report
          path: |
            nuclei.jsonl
            nuclei_report.html
