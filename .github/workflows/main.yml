name: ğŸš€ AnÃ¡lise SAST - Semgrep (pipx)

on:
  workflow_call:
    inputs:
      semgrep_config:
        description: "Config do Semgrep (ex: auto, p/ci, ou path local)"
        required: false
        type: string
        default: "auto"
      upload_artifacts:
        description: "Fazer upload dos relatÃ³rios"
        required: false
        type: boolean
        default: true

jobs:
  semgrep_sast:
    name: SAST Scan (Semgrep)
    runs-on: ubuntu-latest

    steps:
      - name: ğŸ› ï¸ Checkout do RepositÃ³rio
        uses: actions/checkout@v4

      - name: âš™ï¸ Preparar Python
        uses: actions/setup-python@v5
        with:
          python-version: "3.x"

      - name: ğŸ“¦ Instalar pipx + ferramentas
        run: |
          python -m pip install --upgrade pip
          python -m pip install pipx
          pipx ensurepath
          echo "$HOME/.local/bin" >> $GITHUB_PATH
          pipx install semgrep
          pipx install prospector2html

      - name: ğŸ›¡ï¸ Executar Semgrep (sem excludes)
        run: |
          semgrep --config "${{ inputs.semgrep_config }}" --json --output semgrep.json .

      - name: ğŸ“„ Gerar relatÃ³rio HTML (prospector2html)
        run: |
          prospector-html -i semgrep.json -o semgrep_report.html --filter semgrep || true

      - name: ğŸ“¤ Upload artifacts
        if: ${{ inputs.upload_artifacts }}
        uses: actions/upload-artifact@v4
        with:
          name: semgrep-report
          path: |
            semgrep.json
            semgrep_report.html
